import{BufferAttribute as t,Sphere as e,Box3 as n,BufferGeometry as r,ShaderMaterial as i,FrontSide as o,Color as a,Texture as s}from"three";import{NodeMaterial as l}from"three/webgpu";import{uniform as u,texture as c,uv as h,sub as f,clamp as d,add as p,div as g,fwidth as v,smoothstep as y,mix as m,mul as w,oneMinus as b,max as x,min as S}from"three/tsl";import{Font as T}from"three/examples/jsm/Addons.js";function O(t,e,n,r,i,o,a){try{var s=t[o](a),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(r,i)}function k(t,e,n){return e=L(e),function(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,E()?Reflect.construct(e,n||[],L(t).constructor):e.apply(t,n))}function A(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function I(t,e,n){return e&&function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,U(r.key),r)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function _(t,e,n){return(e=U(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function L(t){return L=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},L(t)}function j(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&z(t,e)}function E(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(E=function(){return!!t})()}function P(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function F(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?P(Object(n),!0).forEach(function(e){_(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function W(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
var t,e,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function o(n,r,i,o){var l=r&&r.prototype instanceof s?r:s,u=Object.create(l.prototype);return M(u,"_invoke",function(n,r,i){var o,s,l,u=0,c=i||[],h=!1,f={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return o=e,s=0,l=t,f.n=n,a}};function d(n,r){for(s=n,l=r,e=0;!h&&u&&!i&&e<c.length;e++){var i,o=c[e],d=f.p,p=o[2];n>3?(i=p===r)&&(l=o[(s=o[4])?5:(s=3,3)],o[4]=o[5]=t):o[0]<=d&&((i=n<2&&d<o[1])?(s=0,f.v=r,f.n=o[1]):d<p&&(i=n<3||o[0]>r||r>p)&&(o[4]=n,o[5]=r,f.n=p,s=0))}if(i||n>1)return a;throw h=!0,r}return function(i,c,p){if(u>1)throw TypeError("Generator is already running");for(h&&1===c&&d(c,p),s=c,l=p;(e=s<2?t:l)||!h;){o||(s?s<3?(s>1&&(f.n=-1),d(s,l)):f.n=l:f.v=l);try{if(u=2,o){if(s||(i="next"),e=o[i]){if(!(e=e.call(o,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,s<2&&(s=0)}else 1===s&&(e=o.return)&&e.call(o),s<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),s=1);o=t}else if((e=(h=f.n<0)?l:n.call(r,f))!==a)break}catch(e){o=t,s=1,l=e}finally{u=1}}return{value:e,done:h}}}(n,i,o),!0),u}var a={};function s(){}function l(){}function u(){}e=Object.getPrototypeOf;var c=[][r]?e(e([][r]())):(M(e={},r,function(){return this}),e),h=u.prototype=s.prototype=Object.create(c);function f(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,u):(t.__proto__=u,M(t,i,"GeneratorFunction")),t.prototype=Object.create(h),t}return l.prototype=u,M(h,"constructor",u),M(u,"constructor",l),l.displayName="GeneratorFunction",M(u,i,"GeneratorFunction"),M(h),M(h,i,"Generator"),M(h,r,function(){return this}),M(h,"toString",function(){return"[object Generator]"}),(W=function(){return{w:o,m:f}})()}function M(t,e,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(t){i=0}M=function(t,e,n,r){function o(e,n){M(t,e,function(t){return this._invoke(e,n,t)})}e?i?i(t,e,{value:n,enumerable:!r,configurable:!r,writable:!r}):t[e]=n:(o("next",0),o("throw",1),o("return",2))},M(t,e,n,r)}function z(t,e){return z=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},z(t,e)}function U(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}function C(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var N,D={exports:{}};var G=C((N||(N=1,function(t){var e=/\n/,n="\n",r=/\s/;function i(t,e,n,r){var i=t.indexOf(e,n);return-1===i||i>r?r:i}function o(t){return r.test(t)}function a(t,e,n,r){return{start:e,end:e+Math.min(r,n-e)}}t.exports=function(e,n){return t.exports.lines(e,n).map(function(t){return e.substring(t.start,t.end)}).join("\n")},t.exports.lines=function(t,r){if(0===(r=r||{}).width&&"nowrap"!==r.mode)return[];t=t||"";var s="number"==typeof r.width?r.width:Number.MAX_VALUE,l=Math.max(0,r.start||0),u="number"==typeof r.end?r.end:t.length,c=r.mode,h=r.measure||a;return"pre"===c?function(t,n,r,i,o){for(var a=[],s=r,l=r;l<i&&l<n.length;l++){var u=n.charAt(l),c=e.test(u);if(c||l===i-1){var h=t(n,s,c?l:l+1,o);a.push(h),s=l+1}}return a}(h,t,l,u,s):function(t,e,r,a,s,l){var u=[],c=s;for("nowrap"===l&&(c=Number.MAX_VALUE);r<a&&r<e.length;){for(var h=i(e,n,r,a);r<h&&o(e.charAt(r));)r++;var f=t(e,r,h,c),d=r+(f.end-f.start),p=d+1;if(d<h){for(;d>r&&!o(e.charAt(d));)d--;if(d===r)p>r+1&&p--,d=p;else for(p=d;d>r&&o(e.charAt(d-1));)d--}if(d>=r){var g=t(e,r,d,c);u.push(g)}r=p}return u}(h,t,l,u,s,c)}}(D)),D.exports)),R=["x","e","a","o","n","s","r","c","u","m","v","w","z"],B=["m","w"],H=["H","I","N","E","F","K","L","T","U","V","W","X","Y","Z"],J="\t".charCodeAt(0),Y=" ".charCodeAt(0),V=function(){return I(function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};A(this,t),this.glyphs=[],this._measure=this.computeMetrics.bind(this),this.update(e)},[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"descender",get:function(){return this._descender}},{key:"ascender",get:function(){return this._ascender}},{key:"xHeight",get:function(){return this._xHeight}},{key:"baseline",get:function(){return this._baseline}},{key:"capHeight",get:function(){return this._capHeight}},{key:"lineHeight",get:function(){return this._lineHeight}},{key:"linesTotal",get:function(){return this._linesTotal}},{key:"lettersTotal",get:function(){return this._lettersTotal}},{key:"wordsTotal",get:function(){return this._wordsTotal}},{key:"update",value:function(t){var e=this;if(t=Object.assign({measure:this._measure},t),this._options=t,this._options.tabSize=K(this._options.tabSize,4),!t.font)throw new Error("must provide a valid bitmap font");var n=this.glyphs,r=t.text||"",i=t.font;this._setupSpaceGlyphs(i);var o=G.lines(r,t),a=t.width||0,s=r.split(" ").filter(function(t){return"\n"!==t}).length,l=r.split("").filter(function(t){return"\n"!==t&&" "!==t}).length;n.length=0;var u=o.reduce(function(t,e){return Math.max(t,e.width,a)},0),c=0,h=0,f=K(t.lineHeight,i.common.lineHeight),d=i.common.base,p=f-d,g=t.letterSpacing||0,v=f*o.length-p,y=function(t){if("center"===t)return 1;if("right"===t)return 2;return 0}(this._options.align);h-=v,this._width=u,this._height=v,this._descender=f-d,this._baseline=d,this._xHeight=function(t){for(var e=0;e<R.length;e++){var n=R[e].charCodeAt(0),r=q(t.chars,n);if(r>=0)return t.chars[r].height}return 0}(i),this._capHeight=function(t){for(var e=0;e<H.length;e++){var n=H[e].charCodeAt(0),r=q(t.chars,n);if(r>=0)return t.chars[r].height}return 0}(i),this._lineHeight=f,this._ascender=f-p-this._xHeight;var m=0,w=0;o.forEach(function(t,a){for(var d,p=t.start,v=t.end,b=t.width,x=r.slice(p,v).split(" ").filter(function(t){return""!==t}).length,S=r.slice(p,v).split(" ").join("").length,T=0,O=0,k=p;k<v;k++){var A=r.charCodeAt(k),I=e.getGlyph(i,A);if(I){d&&(c+=$(i,d.id,I.id));var _=c;1===y?_+=(u-b)/2:2===y&&(_+=u-b),n.push({position:[_,h],data:I,index:k,linesTotal:o.length,lineIndex:a,lineLettersTotal:S,lineLetterIndex:T,lineWordsTotal:x,lineWordIndex:O,wordsTotal:s,wordIndex:m,lettersTotal:l,letterIndex:w}),I.id===Y&&d.id!==Y&&(O++,m++),I.id!==Y&&(T++,w++),c+=I.xadvance+g,d=I}}h+=f,c=0}),this._lettersTotal=l,this._wordsTotal=s,this._linesTotal=o.length}},{key:"getGlyph",value:function(t,e){var n=X(t,e);return n||(e===J?this._fallbackTabGlyph:e===Y?this._fallbackSpaceGlyph:null)}},{key:"computeMetrics",value:function(t,e,n,r){var i,o,a=this._options.letterSpacing||0,s=this._options.font,l=0,u=0,c=0;if(!s.chars||0===s.chars.length)return{start:e,end:e,width:0};n=Math.min(t.length,n);for(var h=e;h<n;h++){var f=t.charCodeAt(h);if(i=this.getGlyph(s,f)){i.char=t[h],i.xoffset;var d=(l+=o?$(s,o.id,i.id):0)+i.xadvance+a,p=l+i.width;if(p>=r||d>=r)break;l=d,u=p,o=i}c++}return o&&(u+=o.xoffset),{start:e,end:e+c,width:u}}},{key:"_setupSpaceGlyphs",value:function(t){if(this._fallbackSpaceGlyph=null,this._fallbackTabGlyph=null,t.chars&&0!==t.chars.length){var e=X(t,Y)||function(t){for(var e=0;e<B.length;e++){var n=B[e].charCodeAt(0),r=q(t.chars,n);if(r>=0)return t.chars[r]}return 0}(t)||t.chars[0],n=this._options.tabSize*e.xadvance;this._fallbackSpaceGlyph=e;var r=Object.assign({},e);this._fallbackTabGlyph=Object.assign(r,{x:0,y:0,xadvance:n,id:J,xoffset:0,yoffset:0,width:0,height:0})}}}])}();function X(t,e){if(!t.chars||0===t.chars.length)return null;var n=q(t.chars,e);return n>=0?t.chars[n]:null}function $(t,e,n){if(!t.kernings||0===t.kernings.length)return 0;for(var r=t.kernings,i=0;i<r.length;i++){var o=r[i];if(o.first===e&&o.second===n)return o.amount}return 0}function q(t,e,n){for(var r=n=n||0;r<t.length;r++)if(t[r].id===e)return r;return-1}function K(t,e){return"number"==typeof t?t:"number"==typeof e?e:0}var Z={min:[0,0],max:[0,0]};function Q(t){var e=t.length/2;Z.min[0]=t[0],Z.min[1]=t[1],Z.max[0]=t[0],Z.max[1]=t[1];for(var n=0;n<e;n++){var r=t[2*n+0],i=t[2*n+1];Z.min[0]=Math.min(r,Z.min[0]),Z.min[1]=Math.min(i,Z.min[1]),Z.max[0]=Math.max(r,Z.max[0]),Z.max[1]=Math.max(i,Z.max[1])}}var tt={computeBox:function(t,e){return Q(t),e.min.set(Z.min[0],Z.min[1],0),e.max.set(Z.max[0],Z.max[1],0),e},computeSphere:function(t,e){Q(t);var n=Z.min[0],r=Z.min[1],i=Z.max[0]-n,o=Z.max[1]-r,a=Math.sqrt(i*i+o*o);e.center.set(n+i/2,r+o/2,0),e.radius=a/2}};var et,nt,rt,it,ot,at,st,lt,ut={pages:function(t){var e=new Float32Array(4*t.length*1),n=0;return t.forEach(function(t){var r=t.data.page||0;e[n++]=r,e[n++]=r,e[n++]=r,e[n++]=r}),e},attributes:function(t,e,n,r,i){var o=new Float32Array(4*t.length*2),a=new Float32Array(4*t.length*2),s=new Float32Array(4*t.length*2),l=new Float32Array(4*t.length*2),u=new Float32Array(4*t.length*2),c=new Float32Array(4*t.length*2),h=0,f=0,d=0,p=0,g=0,v=0;return t.forEach(function(t){var y=t.data,m=y.x+y.width,w=y.y+y.height,b=y.x/e,x=y.y/n,S=m/e,T=w/n;r&&(x=(n-y.y)/n,T=(n-w)/n),o[h++]=b,o[h++]=x,o[h++]=b,o[h++]=T,o[h++]=S,o[h++]=T,o[h++]=S,o[h++]=x,a[p++]=t.position[0]/i.width,a[p++]=(t.position[1]+i.height)/i.height,a[p++]=t.position[0]/i.width,a[p++]=(t.position[1]+i.height+y.height)/i.height,a[p++]=(t.position[0]+y.width)/i.width,a[p++]=(t.position[1]+i.height+y.height)/i.height,a[p++]=(t.position[0]+y.width)/i.width,a[p++]=(t.position[1]+i.height)/i.height,s[g++]=0,s[g++]=1,s[g++]=0,s[g++]=0,s[g++]=1,s[g++]=0,s[g++]=1,s[g++]=1,l[v++]=y.width,l[v++]=y.height,l[v++]=y.width,l[v++]=y.height,l[v++]=y.width,l[v++]=y.height,l[v++]=y.width,l[v++]=y.height;var O=t.position[0]+y.xoffset,k=t.position[1]+y.yoffset,A=y.width,I=y.height;u[f++]=O,u[f++]=k,u[f++]=O,u[f++]=k+I,u[f++]=O+A,u[f++]=k+I,u[f++]=O+A,u[f++]=k,c[d++]=O+A/2,c[d++]=k+I/2,c[d++]=O+A/2,c[d++]=k+I/2,c[d++]=O+A/2,c[d++]=k+I/2,c[d++]=O+A/2,c[d++]=k+I/2}),{uvs:o,layoutUvs:a,positions:u,centers:c,glyphUvs:s,glyphResolution:l}},infos:function(t,e){for(var n=new Float32Array(4*t.length),r=new Float32Array(4*t.length),i=new Float32Array(4*t.length),o=new Float32Array(4*t.length),a=new Float32Array(4*t.length),s=new Float32Array(4*t.length),l=new Float32Array(4*t.length),u=new Float32Array(4*t.length),c=new Float32Array(4*t.length),h=new Float32Array(4*t.length),f=0,d=0,p=0,g=0,v=0,y=0,m=0,w=0,b=0,x=0,S=0;S<t.length;S++){var T=t[S];n[f++]=T.linesTotal,n[f++]=T.linesTotal,n[f++]=T.linesTotal,n[f++]=T.linesTotal,r[d++]=T.lineIndex,r[d++]=T.lineIndex,r[d++]=T.lineIndex,r[d++]=T.lineIndex,i[p++]=T.lineLettersTotal,i[p++]=T.lineLettersTotal,i[p++]=T.lineLettersTotal,i[p++]=T.lineLettersTotal,o[g++]=T.lineLetterIndex,o[g++]=T.lineLetterIndex,o[g++]=T.lineLetterIndex,o[g++]=T.lineLetterIndex,a[v++]=T.lineWordsTotal,a[v++]=T.lineWordsTotal,a[v++]=T.lineWordsTotal,a[v++]=T.lineWordsTotal,s[y++]=T.lineWordIndex,s[y++]=T.lineWordIndex,s[y++]=T.lineWordIndex,s[y++]=T.lineWordIndex,l[m++]=T.wordsTotal,l[m++]=T.wordsTotal,l[m++]=T.wordsTotal,l[m++]=T.wordsTotal,u[w++]=T.wordIndex,u[w++]=T.wordIndex,u[w++]=T.wordIndex,u[w++]=T.wordIndex,c[b++]=T.lettersTotal,c[b++]=T.lettersTotal,c[b++]=T.lettersTotal,c[b++]=T.lettersTotal,h[x++]=T.letterIndex,h[x++]=T.letterIndex,h[x++]=T.letterIndex,h[x++]=T.letterIndex}return{linesTotal:n,lineIndex:r,lineLettersTotal:i,lineLetterIndex:o,lineWordsTotal:a,lineWordIndex:s,wordsTotal:l,wordIndex:u,lettersTotal:c,letterIndex:h}}};function ct(){return nt?et:(nt=1,et=function(t){switch(t){case"int8":return Int8Array;case"int16":return Int16Array;case"int32":return Int32Array;case"uint8":return Uint8Array;case"uint16":return Uint16Array;case"uint32":return Uint32Array;case"float32":return Float32Array;case"float64":return Float64Array;case"array":return Array;case"uint8_clamped":return Uint8ClampedArray}})}function ht(){if(at)return ot;function t(t){return!!t.constructor&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)}return at=1,ot=function(e){return null!=e&&(t(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&t(e.slice(0,0))}(e)||!!e._isBuffer)}}var ft=function(){if(lt)return st;lt=1;var t=ct(),e=function(){if(it)return rt;it=1;var t=Object.prototype.toString;return rt=function(e){return e.BYTES_PER_ELEMENT&&"[object ArrayBuffer]"===t.call(e.buffer)||Array.isArray(e)}}
/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(),n=ht(),r=[0,2,3],i=[2,1,3];return st=function(o,a){o&&(e(o)||n(o))||(a=o||{},o=null);for(var s="string"==typeof(a="number"==typeof a?{count:a}:a||{}).type?a.type:"uint16",l="number"==typeof a.count?a.count:1,u=a.start||0,c=!1!==a.clockwise?r:i,h=c[0],f=c[1],d=c[2],p=6*l,g=o||new(t(s))(p),v=0,y=0;v<p;v+=6,y+=4){var m=v+u;g[m+0]=y+0,g[m+1]=y+1,g[m+2]=y+2,g[m+3]=y+h,g[m+4]=y+f,g[m+5]=y+d}return g}}(),dt=C(ft),pt=function(){function i(t){var e;return A(this,i),"string"==typeof t&&(t={text:t}),(e=k(this,i))._options=Object.assign({},t),e._layout=null,e._visibleGlyphs=[],e.update(e._options),e}return j(i,r),I(i,[{key:"layout",get:function(){return this._layout}},{key:"visibleGlyphs",get:function(){return this._visibleGlyphs}},{key:"update",value:function(e){if(e=this._validateOptions(e)){this._layout=function(t){return new V(t)}(e);var n=!1!==e.flipY,r=e.font,i=r.common.scaleW,o=r.common.scaleH,a=this._layout.glyphs.filter(function(t){var e=t.data;return e.width*e.height>0});this._visibleGlyphs=a;var s=ut.attributes(a,i,o,n,this._layout),l=ut.infos(a,this._layout),u=dt([],{clockwise:!0,type:"uint16",count:a.length});if(this.setIndex(u),this.setAttribute("position",new t(s.positions,2)),this.setAttribute("center",new t(s.centers,2)),this.setAttribute("uv",new t(s.uvs,2)),this.setAttribute("layoutUv",new t(s.layoutUvs,2)),this.setAttribute("glyphUv",new t(s.glyphUvs,2)),this.setAttribute("glyphResolution",new t(s.glyphResolution,2)),this.setAttribute("lineIndex",new t(l.lineIndex,1)),this.setAttribute("lineLettersTotal",new t(l.lineLettersTotal,1)),this.setAttribute("lineLetterIndex",new t(l.lineLetterIndex,1)),this.setAttribute("lineWordsTotal",new t(l.lineWordsTotal,1)),this.setAttribute("lineWordIndex",new t(l.lineWordIndex,1)),this.setAttribute("wordIndex",new t(l.wordIndex,1)),this.setAttribute("letterIndex",new t(l.letterIndex,1)),!e.multipage&&"page"in this.attributes)this.deleteAttribute("page");else if(e.multipage){var c=ut.pages(a);this.setAttribute("page",new t(c,1))}}}},{key:"computeBoundingSphere",value:function(){null===this.boundingSphere&&(this.boundingSphere=new e);var t=this.attributes.position.array,n=this.attributes.position.itemSize;if(!t||!n||t.length<2)return this.boundingSphere.radius=0,void this.boundingSphere.center.set(0,0,0);tt.computeSphere(t,this.boundingSphere),isNaN(this.boundingSphere.radius)&&console.error('BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.')}},{key:"computeBoundingBox",value:function(){null===this.boundingBox&&(this.boundingBox=new n);var t=this.boundingBox,e=this.attributes.position.array,r=this.attributes.position.itemSize;if(e&&r&&!(e.length<2))return tt.computeBox(e,t);t.makeEmpty()}},{key:"_validateOptions",value:function(t){if("string"==typeof t&&(t={text:t}),!(t=Object.assign({},this._options,t)).font)throw new TypeError("must specify a { font } in options");return t}}])}(),gt={common:{uOpacity:{value:1},uColor:{value:{r:255,g:255,b:255}},uMap:{value:null}},rendering:{uThreshold:{value:.2},uAlphaTest:{value:.01}},strokes:{uStrokeColor:{value:{r:255,g:0,b:0}},uStrokeOutsetWidth:{value:0},uStrokeInsetWidth:{value:.3}}},vt={side:o,transparent:!0,defines:{IS_SMALL:!1},extensions:{derivatives:!0},uniforms:F(F(F({},gt.common),gt.rendering),gt.strokes),vertexShader:"#define GLSLIFY 1\nattribute vec2 layoutUv;attribute float lineIndex;attribute float lineLettersTotal;attribute float lineLetterIndex;attribute float lineWordsTotal;attribute float lineWordIndex;attribute float wordIndex;attribute float letterIndex;varying vec2 vUv;varying vec2 vLayoutUv;varying vec3 vViewPosition;varying vec3 vNormal;varying float vLineIndex;varying float vLineLettersTotal;varying float vLineLetterIndex;varying float vLineWordsTotal;varying float vLineWordIndex;varying float vWordIndex;varying float vLetterIndex;void main(){vec4 mvPosition=vec4(position,1.0);mvPosition=modelViewMatrix*mvPosition;gl_Position=projectionMatrix*mvPosition;vUv=uv;vLayoutUv=layoutUv;vViewPosition=-mvPosition.xyz;vNormal=normal;vLineIndex=lineIndex;vLineLettersTotal=lineLettersTotal;vLineLetterIndex=lineLetterIndex;vLineWordsTotal=lineWordsTotal;vLineWordIndex=lineWordIndex;vWordIndex=wordIndex;vLetterIndex=letterIndex;}",fragmentShader:"#define GLSLIFY 1\nvarying vec2 vUv;uniform float uOpacity;uniform float uThreshold;uniform float uAlphaTest;uniform vec3 uColor;uniform sampler2D uMap;uniform vec3 uStrokeColor;uniform float uStrokeOutsetWidth;uniform float uStrokeInsetWidth;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}void main(){vec3 s=texture2D(uMap,vUv).rgb;float sigDist=median(s.r,s.g,s.b)-0.5;float afwidth=1.4142135623730951/2.0;\n#ifdef IS_SMALL\nfloat alpha=smoothstep(uThreshold-afwidth,uThreshold+afwidth,sigDist);\n#else\nfloat alpha=clamp(sigDist/fwidth(sigDist)+0.5,0.0,1.0);\n#endif\nfloat sigDistOutset=sigDist+uStrokeOutsetWidth*0.5;float sigDistInset=sigDist-uStrokeInsetWidth*0.5;\n#ifdef IS_SMALL\nfloat outset=smoothstep(uThreshold-afwidth,uThreshold+afwidth,sigDistOutset);float inset=1.0-smoothstep(uThreshold-afwidth,uThreshold+afwidth,sigDistInset);\n#else\nfloat outset=clamp(sigDistOutset/fwidth(sigDistOutset)+0.5,0.0,1.0);float inset=1.0-clamp(sigDistInset/fwidth(sigDistInset)+0.5,0.0,1.0);\n#endif\nfloat border=outset*inset;if(alpha<uAlphaTest)discard;vec4 filledFragColor=vec4(uColor,uOpacity*alpha);gl_FragColor=filledFragColor;}"},yt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return A(this,t),k(this,t,[e=Object.assign(JSON.parse(JSON.stringify(vt)),e)])}return j(t,i),I(t)}(),mt={transparent:!0,opacity:1,alphaTest:.01,threshold:.2,color:"#ffffff",strokeColor:"#000000",strokeOutsetWidth:0,strokeInsetWidth:.3,isSmooth:0},wt=function(){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};A(this,t),n=Object.assign(JSON.parse(JSON.stringify(mt)),n),(e=k(this,t)).transparent=n.transparent,e.alphaTest=n.alphaTest,e.opacity=u(n.opacity),e.color=u(new a(n.color)),e.map=n.map,e.isSmooth=u(n.isSmooth),e.threshold=u(n.threshold),e.strokeColor=u(new a(n.strokeColor)),e.strokeOutsetWidth=u(n.strokeOutsetWidth),e.strokeInsetWidth=u(n.strokeInsetWidth);var r,i,o,s=.7071067811865476,l=c(e.map,h()),T=f((r=l.r,i=l.g,o=l.b,x(S(r,i),S(x(r,i),o))),.5),O=d(p(g(T,v(T)),.5),0,1),I=y(f(e.threshold,s),p(e.threshold,s),T);O=m(O,I,e.isSmooth);var _=p(T,w(e.strokeOutsetWidth,.5)),L=f(T,w(e.strokeOutsetWidth,.5)),j=d(p(g(_,v(_)),.5),0,1),E=b(d(p(g(L,v(L)),.5),0,1)),P=y(f(e.threshold,s),p(e.threshold,s),_),F=b(y(f(e.threshold,s),p(e.threshold,s),L));j=m(j,P,e.isSmooth),E=m(E,F,e.isSmooth);var W=w(j,E);return e.colorNode=m(e.color,e.strokeColor,W),e.opacityNode=w(e.opacity,p(O,W)),e}return j(t,l),I(t)}();
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
const bt=Symbol("Comlink.proxy"),xt=Symbol("Comlink.endpoint"),St=Symbol("Comlink.releaseProxy"),Tt=Symbol("Comlink.finalizer"),Ot=Symbol("Comlink.thrown"),kt=t=>"object"==typeof t&&null!==t||"function"==typeof t,At=new Map([["proxy",{canHandle:t=>kt(t)&&t[bt],serialize(t){const{port1:e,port2:n}=new MessageChannel;return It(t,e),[n,[n]]},deserialize:t=>(t.start(),Lt(t))}],["throw",{canHandle:t=>kt(t)&&Ot in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function It(t,e=globalThis,n=["*"]){e.addEventListener("message",function r(i){if(!i||!i.data)return;if(!function(t,e){for(const n of t){if(e===n||"*"===n)return!0;if(n instanceof RegExp&&n.test(e))return!0}return!1}(n,i.origin))return void console.warn(`Invalid origin '${i.origin}' for comlink proxy`);const{id:o,type:a,path:s}=Object.assign({path:[]},i.data),l=(i.data.argumentList||[]).map(Ct);let u;try{const e=s.slice(0,-1).reduce((t,e)=>t[e],t),n=s.reduce((t,e)=>t[e],t);switch(a){case"GET":u=n;break;case"SET":e[s.slice(-1)[0]]=Ct(i.data.value),u=!0;break;case"APPLY":u=n.apply(e,l);break;case"CONSTRUCT":u=function(t){return Object.assign(t,{[bt]:!0})}(new n(...l));break;case"ENDPOINT":{const{port1:e,port2:n}=new MessageChannel;It(t,n),u=function(t,e){return zt.set(t,e),t}(e,[e])}break;case"RELEASE":u=void 0;break;default:return}}catch(t){u={value:t,[Ot]:0}}Promise.resolve(u).catch(t=>({value:t,[Ot]:0})).then(n=>{const[i,s]=Ut(n);e.postMessage(Object.assign(Object.assign({},i),{id:o}),s),"RELEASE"===a&&(e.removeEventListener("message",r),_t(e),Tt in t&&"function"==typeof t[Tt]&&t[Tt]())}).catch(t=>{const[n,r]=Ut({value:new TypeError("Unserializable return value"),[Ot]:0});e.postMessage(Object.assign(Object.assign({},n),{id:o}),r)})}),e.start&&e.start()}function _t(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function Lt(t,e){const n=new Map;return t.addEventListener("message",function(t){const{data:e}=t;if(!e||!e.id)return;const r=n.get(e.id);if(r)try{r(e)}finally{n.delete(e.id)}}),Wt(t,n,[],e)}function jt(t){if(t)throw new Error("Proxy has been released and is not useable")}function Et(t){return Nt(t,new Map,{type:"RELEASE"}).then(()=>{_t(t)})}const Pt=new WeakMap,Ft="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(Pt.get(t)||0)-1;Pt.set(t,e),0===e&&Et(t)});function Wt(t,e,n=[],r=function(){}){let i=!1;const o=new Proxy(r,{get(r,a){if(jt(i),a===St)return()=>{!function(t){Ft&&Ft.unregister(t)}(o),Et(t),e.clear(),i=!0};if("then"===a){if(0===n.length)return{then:()=>o};const r=Nt(t,e,{type:"GET",path:n.map(t=>t.toString())}).then(Ct);return r.then.bind(r)}return Wt(t,e,[...n,a])},set(r,o,a){jt(i);const[s,l]=Ut(a);return Nt(t,e,{type:"SET",path:[...n,o].map(t=>t.toString()),value:s},l).then(Ct)},apply(r,o,a){jt(i);const s=n[n.length-1];if(s===xt)return Nt(t,e,{type:"ENDPOINT"}).then(Ct);if("bind"===s)return Wt(t,e,n.slice(0,-1));const[l,u]=Mt(a);return Nt(t,e,{type:"APPLY",path:n.map(t=>t.toString()),argumentList:l},u).then(Ct)},construct(r,o){jt(i);const[a,s]=Mt(o);return Nt(t,e,{type:"CONSTRUCT",path:n.map(t=>t.toString()),argumentList:a},s).then(Ct)}});return function(t,e){const n=(Pt.get(e)||0)+1;Pt.set(e,n),Ft&&Ft.register(t,e,t)}(o,t),o}function Mt(t){const e=t.map(Ut);return[e.map(t=>t[0]),(n=e.map(t=>t[1]),Array.prototype.concat.apply([],n))];var n}const zt=new WeakMap;function Ut(t){for(const[e,n]of At)if(n.canHandle(t)){const[r,i]=n.serialize(t);return[{type:"HANDLER",name:e,value:r},i]}return[{type:"RAW",value:t},zt.get(t)||[]]}function Ct(t){switch(t.type){case"HANDLER":return At.get(t.name).deserialize(t.value);case"RAW":return t.value}}function Nt(t,e,n,r){return new Promise(i=>{const o=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");e.set(o,i),t.start&&t.start(),t.postMessage(Object.assign({id:o},n),r)})}var Dt=class{worker;api;initPromise;constructor(t,e){this.worker=new Worker(t,{type:"module"}),this.api=Lt(this.worker),this.initPromise=this.api.initialize(e)}initialize=()=>this.initPromise;loadFont=async t=>(await this.initPromise,this.api.loadFont(t));generateAtlas=t=>this.api.generateAtlas(t);exportJSON=t=>this.api.exportJSON(t);dispose=()=>this.api.dispose();generateMSDFAtlas=t=>this.api.generateMSDFAtlas(t);generateMSDFFont=t=>this.api.generateMSDFFont(t);terminate=()=>this.worker.terminate()},Gt=class{static Encoder=new TextEncoder;client=null;workerUrl;wasmUrl;initialized=!1;constructor(t={}){this.workerUrl=t.workerUrl||new URL("./worker.js",import.meta.url).href,this.wasmUrl=t.wasmUrl}async initialize(){this.initialized||(this.client=new Dt(this.workerUrl,this.wasmUrl),await this.client.initialize(),this.initialized=!0)}async generate(t){if(!this.client||!this.initialized)throw new Error("MSDF not initialized. Call initialize() first.");return t.fonts?this.generateMultiple(t):this.generateSingle(t)}async generateSingle(t){const{onProgress:e,...n}=t;await this.client.loadFont(n.font);const r=await this.client.generateAtlas(n),i=await this.client.exportJSON({atlas:r,fontSize:t.fontSize||48}),o=await this.atlasToBlob(r),a={...i,pages:[`data:image/png;base64,${await this.blobToBase64(o)}`]};return e?.(100,1,1),this.toFontFamily(a,r.info.name||"font",r.info.weight||400)}async generateMultiple(t){const{fonts:e,onProgress:n,...r}=t;if(!e||0===e.length)throw new Error("No fonts provided");const i={};let o=0;const a=e.length;for(const t of e){const{font:e,...s}=t,l={...r,...s,font:e,charset:s.charset??r.charset??""};if(!l.charset)throw new Error("charset is required globally or per-font");const u=await this.generateSingle(l);for(const[t,e]of Object.entries(u))for(const[n,r]of Object.entries(e)){const e=Number(n);i[t]?.[e]&&console.warn(`Duplicate font: ${t} (${e}). Overwriting.`),i[t]||(i[t]={}),i[t][e]=r}o++,n?.(Math.round(o/a*100),o,a)}return i}async generateAtlas(t){if(!this.client||!this.initialized)throw new Error("MSDF not initialized. Call initialize() first.");const{onProgress:e,...n}=t;return await this.client.loadFont(n.font),await this.client.generateAtlas(n)}async dispose(){this.client&&(await this.client.dispose(),this.client.terminate(),this.client=null,this.initialized=!1)}async toFontFamily(t,e,n){return{[e]:{[n]:t}}}atlasToBlob(t){const e=document.createElement("canvas");return e.width=t.textureSize[0],e.height=t.textureSize[1],e.getContext("2d").putImageData(t.texture,0,0),new Promise((t,n)=>{e.toBlob(e=>e?t(e):n(new Error("Failed to create blob")),"image/png")})}blobToBase64(t){return new Promise((e,n)=>{const r=new FileReader;r.onloadend=()=>e(r.result.split(",")[1]),r.onerror=n,r.readAsDataURL(t)})}},Rt={charset:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 ",fontSize:48,textureSize:[512,512],fieldRange:4,fixOverlaps:!0,onProgress:function(){}},Bt=function(){var t,e=(t=W().m(function t(e){var n,r,i,o,a,l,u,c,h,f,d,p,g=arguments;return W().w(function(t){for(;;)switch(t.n){case 0:return n=g.length>1&&void 0!==g[1]?g[1]:{},r=F(F({},Rt),n),i=new Gt({workerUrl:r.workerUrl,wasmUrl:r.wasmUrl}),t.n=1,i.initialize();case 1:return t.n=2,fetch(e);case 2:return o=t.v,t.n=3,o.arrayBuffer();case 3:return a=t.v,l=new Uint8Array(a),t.n=4,i.generate({font:l,charset:r.charset,fontSize:r.fontSize,textureSize:r.textureSize,fieldRange:r.fieldRange,fixOverlaps:r.fixOverlaps,onProgress:r.onProgress});case 4:return u=t.v,t.n=5,i.dispose();case 5:return c=Object.keys(u)[0],h=Object.keys(u[c])[0],f=u[c][h],d=f.pages[0],t.n=6,new Promise(function(t,e){var n=new Image;n.onload=function(){var e=new s(n);e.needsUpdate=!0,t(e)},n.onerror=e,n.src=d});case 6:return p=t.v,t.a(2,{font:new T(f),atlas:p})}},t)}),function(){var e=this,n=arguments;return new Promise(function(r,i){var o=t.apply(e,n);function a(t){O(o,r,i,a,s,"next",t)}function s(t){O(o,r,i,a,s,"throw",t)}a(void 0)})});return function(t){return e.apply(this,arguments)}}();export{pt as MSDFTextGeometry,yt as MSDFTextMaterial,wt as MSDFTextNodeMaterial,Bt as generateMSDF,gt as uniforms};
